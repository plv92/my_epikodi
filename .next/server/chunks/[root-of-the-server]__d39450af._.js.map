{
  "version": 3,
  "sources": [],
  "sections": [
    {"offset": {"line": 6, "column": 0}, "map": {"version":3,"sources":[],"names":[],"mappings":"","debugId":null}},
    {"offset": {"line": 116, "column": 0}, "map": {"version":3,"sources":["file:///home/plv92/Desktop/TEK3/Epikodi/src/app/api/upload/route.ts"],"sourcesContent":["import { NextRequest, NextResponse } from \"next/server\";\nimport { PrismaClient } from \"@prisma/client\";\nimport { writeFile } from \"fs/promises\";\nimport { join } from \"path\";\nimport { parseBuffer } from \"music-metadata\";\n\nconst prisma = new PrismaClient();\n\nexport const config = {\n  api: {\n    bodyParser: false,\n  },\n};\n\n// POST /api/upload - Upload d'un fichier audio\nexport async function POST(request: NextRequest) {\n  try {\n    const formData = await request.formData();\n    const file = formData.get(\"file\") as File;\n\n    if (!file) {\n      return NextResponse.json({ error: \"Aucun fichier fourni\" }, { status: 400 });\n    }\n\n    // Vérifier le type de fichier\n    if (!file.type.startsWith(\"audio/\")) {\n      return NextResponse.json({ error: \"Le fichier doit être un fichier audio\" }, { status: 400 });\n    }\n\n    // Convertir le fichier en buffer\n    const bytes = await file.arrayBuffer();\n    const buffer = Buffer.from(bytes);\n\n    // Parser les métadonnées\n    let metadata;\n    try {\n      metadata = await parseBuffer(buffer, { mimeType: file.type });\n    } catch (error) {\n      console.error(\"Erreur parsing métadonnées:\", error);\n      metadata = null;\n    }\n\n    // Générer un nom de fichier unique\n    const timestamp = Date.now();\n    const filename = `${timestamp}-${file.name.replace(/[^a-zA-Z0-9.-]/g, \"_\")}`;\n    const filepath = join(process.cwd(), \"public\", \"music\", filename);\n\n    // Sauvegarder le fichier\n    await writeFile(filepath, buffer);\n\n    // Créer l'entrée en base de données\n    const track = await prisma.track.create({\n        data: {\n          title: metadata?.common?.title || file.name.replace(/\\.[^/.]+$/, \"\"),\n          artist: metadata?.common?.artist || \"Artiste inconnu\",\n          album: metadata?.common?.album || null,\n          genre: metadata?.common?.genre?.[0] || null,\n          year: metadata?.common?.year || null,\n          // duration retiré car non supporté par Prisma\n          url: `/music/${filename}`,\n          cover: null, // TODO: extraire la cover depuis les métadonnées\n      },\n    });\n\n    return NextResponse.json(track, { status: 201 });\n  } catch (error) {\n    console.error(\"Erreur upload:\", error);\n    return NextResponse.json({ error: \"Erreur lors de l'upload du fichier\" }, { status: 500 });\n  }\n}\n"],"names":[],"mappings":";;;;AAAA;AACA;AACA;AACA;AACA;;;;;;AAEA,MAAM,SAAS,IAAI,6HAAA,CAAA,eAAY;AAExB,MAAM,SAAS;IACpB,KAAK;QACH,YAAY;IACd;AACF;AAGO,eAAe,KAAK,OAAoB;IAC7C,IAAI;QACF,MAAM,WAAW,MAAM,QAAQ,QAAQ;QACvC,MAAM,OAAO,SAAS,GAAG,CAAC;QAE1B,IAAI,CAAC,MAAM;YACT,OAAO,gIAAA,CAAA,eAAY,CAAC,IAAI,CAAC;gBAAE,OAAO;YAAuB,GAAG;gBAAE,QAAQ;YAAI;QAC5E;QAEA,8BAA8B;QAC9B,IAAI,CAAC,KAAK,IAAI,CAAC,UAAU,CAAC,WAAW;YACnC,OAAO,gIAAA,CAAA,eAAY,CAAC,IAAI,CAAC;gBAAE,OAAO;YAAwC,GAAG;gBAAE,QAAQ;YAAI;QAC7F;QAEA,iCAAiC;QACjC,MAAM,QAAQ,MAAM,KAAK,WAAW;QACpC,MAAM,SAAS,OAAO,IAAI,CAAC;QAE3B,yBAAyB;QACzB,IAAI;QACJ,IAAI;YACF,WAAW,MAAM,CAAA,GAAA,kKAAA,CAAA,cAAW,AAAD,EAAE,QAAQ;gBAAE,UAAU,KAAK,IAAI;YAAC;QAC7D,EAAE,OAAO,OAAO;YACd,QAAQ,KAAK,CAAC,+BAA+B;YAC7C,WAAW;QACb;QAEA,mCAAmC;QACnC,MAAM,YAAY,KAAK,GAAG;QAC1B,MAAM,WAAW,GAAG,UAAU,CAAC,EAAE,KAAK,IAAI,CAAC,OAAO,CAAC,mBAAmB,MAAM;QAC5E,MAAM,WAAW,CAAA,GAAA,iGAAA,CAAA,OAAI,AAAD,EAAE,QAAQ,GAAG,IAAI,UAAU,SAAS;QAExD,yBAAyB;QACzB,MAAM,CAAA,GAAA,qHAAA,CAAA,YAAS,AAAD,EAAE,UAAU;QAE1B,oCAAoC;QACpC,MAAM,QAAQ,MAAM,OAAO,KAAK,CAAC,MAAM,CAAC;YACpC,MAAM;gBACJ,OAAO,UAAU,QAAQ,SAAS,KAAK,IAAI,CAAC,OAAO,CAAC,aAAa;gBACjE,QAAQ,UAAU,QAAQ,UAAU;gBACpC,OAAO,UAAU,QAAQ,SAAS;gBAClC,OAAO,UAAU,QAAQ,OAAO,CAAC,EAAE,IAAI;gBACvC,MAAM,UAAU,QAAQ,QAAQ;gBAChC,8CAA8C;gBAC9C,KAAK,CAAC,OAAO,EAAE,UAAU;gBACzB,OAAO;YACX;QACF;QAEA,OAAO,gIAAA,CAAA,eAAY,CAAC,IAAI,CAAC,OAAO;YAAE,QAAQ;QAAI;IAChD,EAAE,OAAO,OAAO;QACd,QAAQ,KAAK,CAAC,kBAAkB;QAChC,OAAO,gIAAA,CAAA,eAAY,CAAC,IAAI,CAAC;YAAE,OAAO;QAAqC,GAAG;YAAE,QAAQ;QAAI;IAC1F;AACF","debugId":null}}]
}